<!doctype html>
<html lang="en" id="htmlRoot">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Math Quest ğŸª™ (2 Players â€¢ Kids)</title>

  <!-- Fonts (Cairo + Tajawal) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">

  <!-- PyScript -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2025.11.2/core.css">
  <script type="module" src="https://pyscript.net/releases/2025.11.2/core.js"></script>

  <style>
    :root{
      --bg1:#7c3aed;
      --bg2:#06b6d4;
      --card:#ffffffee;
      --ink:#102a43;
      --soft:#f2f7ff;
      --line:#d7e3ff;

      --p1:#ff4d6d;
      --p2:#3b82f6;

      --btnGood:#22c55e;
      --btnHint:#f59e0b;
      --btnReset:#8b5cf6;

      --overlay:#0b1220cc;
    }
    *{ box-sizing:border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: "Cairo","Tajawal",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--ink);
      min-height:100vh;
      background:
        radial-gradient(circle at 15% 20%, #ffffff55 0 12px, transparent 13px),
        radial-gradient(circle at 80% 30%, #ffffff55 0 10px, transparent 11px),
        radial-gradient(circle at 40% 80%, #ffffff55 0 14px, transparent 15px),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      overflow-x:hidden;

      /* ÙŠÙ‚Ù„Ù„ Ø§Ù‡ØªØ²Ø§Ø² Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ ÙÙŠ iOS */
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: none;
    }

    .wrap{ max-width: 1040px; margin: 18px auto; padding: 14px; }
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      flex-wrap:wrap; margin-bottom: 12px;
    }
    .title{ display:flex; gap:12px; align-items:center; }
    .logo{
      width:58px; height:58px; border-radius:18px;
      background: linear-gradient(135deg, #ffe066, #ff4d6d);
      display:grid; place-items:center;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      transform: rotate(-6deg);
      animation: wiggle 2.8s ease-in-out infinite;
      user-select:none;
      font-size: 30px;
    }
    @keyframes wiggle{
      0%,100%{ transform: rotate(-6deg) translateY(0); }
      50%{ transform: rotate(6deg) translateY(-2px); }
    }
    h1{ margin:0; font-size: 26px; letter-spacing:.3px; font-weight: 900; }
    .subtitle{ margin:2px 0 0; font-size: 13px; opacity:.88; font-weight: 700; }

    .globalCard{
      background: var(--card);
      border: 3px solid #ffffff88;
      border-radius: 22px;
      padding: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }

    .pill{
      background:#fff;
      border:2px solid var(--line);
      border-radius: 999px;
      padding: 9px 12px;
      font-size: 13px;
      display:flex; gap:8px; align-items:center;
      box-shadow: 0 10px 25px rgba(16,42,67,.08);
      user-select:none;
      flex-wrap:wrap;
      font-weight: 800;
    }

    .langWrap{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      background:#fff;
      border:2px solid var(--line);
      border-radius:999px;
      padding: 8px 10px;
      box-shadow: 0 10px 25px rgba(16,42,67,.08);
    }
    .langWrap label{ font-weight:900; font-size: 13px; }
    select{
      border:2px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 900;
      background:#fff;
      cursor:pointer;
      outline:none;
      font-family: inherit;
    }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      border:none;
      padding: 12px 14px;
      border-radius: 18px;
      font-size: 15px;
      font-weight: 900;
      cursor:pointer;
      color:#0b1220;
      box-shadow: 0 14px 30px rgba(0,0,0,.16);
      transform: translateY(0);
      transition: .12s ease;
      user-select:none;
      white-space: nowrap;
      font-family: inherit;
    }
    button:active{ transform: translateY(2px) scale(.99); }
    .btnReset{ background: linear-gradient(135deg, var(--btnReset), #93c5fd); }
    .btnSubmit{ background: linear-gradient(135deg, var(--btnGood), #a3e635); }
    .btnHint{ background: linear-gradient(135deg, var(--btnHint), #fde047); }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
    }

    .playerCard{
      background: var(--card);
      border: 3px solid #ffffff88;
      border-radius: 22px;
      padding: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,.22);
      position: relative;
      overflow:hidden;
    }
    .playerCard::before{
      content:"";
      position:absolute; inset:-50px;
      background:
        radial-gradient(circle at 12% 18%, #ffe06655 0 26px, transparent 27px),
        radial-gradient(circle at 78% 22%, #ffffff55 0 22px, transparent 23px),
        radial-gradient(circle at 20% 84%, #22c55e33 0 26px, transparent 27px),
        radial-gradient(circle at 86% 78%, #3b82f633 0 24px, transparent 25px);
      z-index:0;
      pointer-events:none;
    }
    .playerCard > *{ position:relative; z-index:1; }

    .playerHeader{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .tag{
      display:flex; align-items:center; gap:10px;
      user-select:none;
      font-weight: 900;
    }
    .badge{
      width:30px; height:30px; border-radius:12px;
      display:grid; place-items:center; color:white;
      font-size: 16px; font-weight:900;
      box-shadow: 0 10px 20px rgba(0,0,0,.14);
    }
    .b1{ background: linear-gradient(135deg, var(--p1), #f43f5e); }
    .b2{ background: linear-gradient(135deg, var(--p2), #06b6d4); }

    .nameRow{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .nameRow label{ font-weight: 900; font-size: 13px; }

    /* Ù…Ù‡Ù… Ù„Ù„Ø¢ÙŠØ¨Ø§Ø¯: Ø­Ø¬Ù… Ø§Ù„Ø®Ø· 16+ ÙŠÙ…Ù†Ø¹ Safari Zoom ÙˆÙŠÙ‚Ù„Ù„ Ù†Ø²ÙˆÙ„ Ø§Ù„ØµÙØ­Ø© */
    input[type="text"], input[type="number"]{
      padding: 12px 12px;
      border-radius: 16px;
      border: 3px solid #cfe0ff;
      background:#ffffff;
      font-size: 16px;   /* Ù„Ø§ ØªÙ‚Ù„ Ø¹Ù† 16 */
      outline:none;
      transition: .15s ease;
      width: 220px;
      max-width: 100%;
      font-family: inherit;
    }
    input[type="number"]{ width: 100%; }
    input:focus{
      border-color:#7c3aed;
      box-shadow: 0 0 0 6px rgba(124,58,237,.15);
    }

    .statsRow{ display:flex; flex-wrap:wrap; gap:10px; margin: 8px 0 10px; }

    /* Progress / Car track */
    .progressWrap{
      background: #ffffff;
      border: 2px solid var(--line);
      border-radius: 18px;
      padding: 10px 12px;
      box-shadow: 0 10px 25px rgba(16,42,67,.08);
      margin-bottom: 10px;
    }
    .progressTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-weight: 900;
      font-size: 13px;
      user-select:none;
    }
    .track{
      position: relative;
      margin-top: 10px;
      height: 14px;
      border-radius: 999px;
      background: linear-gradient(90deg, #eaf2ff, #ffffff);
      border: 2px dashed #bcd4ff;
      overflow: hidden;
    }
    .fill{
      position:absolute;
      inset:0;
      width: calc(var(--pos, 0) * 100%);
      background: linear-gradient(90deg, #22c55e55, #a3e63555);
    }
    .car{
      position:absolute;
      top: 50%;
      left: calc(var(--pos, 0) * 100%);
      transform: translate(-50%, -55%);
      font-size: 20px;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.18));
      transition: left .35s ease;
      user-select:none;
      white-space: nowrap;
    }
    .trackMarks{
      display:flex;
      justify-content:space-between;
      margin-top: 6px;
      font-size: 12px;
      font-weight: 900;
      opacity: .75;
      user-select:none;
    }

    .questionBox{
      background: var(--soft);
      border: 3px dashed #bcd4ff;
      border-radius: 18px;
      padding: 14px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
    }
    .question{
      font-size: 32px;
      font-weight: 900;
      letter-spacing:.5px;
    }
    .mascot{
      font-size: 34px;
      animation: bounce 1.6s ease-in-out infinite;
      user-select:none;
    }
    @keyframes bounce{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(-6px); }
    }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }

    .coinsPop{ display:inline-block; animation: pop .35s ease; }
    @keyframes pop{
      0%{ transform: scale(.8); opacity:.2; }
      100%{ transform: scale(1); opacity:1; }
    }

    /* Pop feedback badge (4 seconds) */
    .popBadge{
      position: fixed;
      left: 50%;
      top: 16px;
      transform: translateX(-50%);
      padding: 12px 16px;
      border-radius: 16px;
      font-weight: 1000;
      font-size: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
      z-index: 9999;
      display:none;
      user-select:none;
      border: 2px solid #ffffffaa;
      text-align:center;
      max-width: min(92vw, 760px);
      line-height: 1.2;
      font-family: inherit;
    }
    .popGood{ background: linear-gradient(135deg, #22c55e, #a3e635); }
    .popBad{ background: linear-gradient(135deg, #fb7185, #ffb4c0); }
    .popInfo{ background: linear-gradient(135deg, #60a5fa, #93c5fd); }
    .popShow{ display:block; animation: popDrop .55s ease; }
    @keyframes popDrop{
      0%{ transform: translateX(-50%) translateY(-18px) scale(.92); opacity:.25; }
      100%{ transform: translateX(-50%) translateY(0) scale(1); opacity:1; }
    }

    /* Level result overlay */
    .overlay{
      position: fixed; inset:0;
      background: var(--overlay);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 9998;
    }
    .overlay.show{ display:flex; }
    .modal{
      width: min(560px, 96vw);
      background: #ffffff;
      border-radius: 22px;
      border: 3px solid #ffffffaa;
      box-shadow: 0 20px 80px rgba(0,0,0,.35);
      padding: 16px;
      text-align:center;
      font-family: inherit;
    }
    .modal h2{ margin: 6px 0 6px; font-weight: 900; }
    .modal p{ margin: 6px 0; font-size: 14px; opacity:.9; font-weight: 800; }
    .modal .big{ font-size: 34px; font-weight: 1000; margin: 6px 0; }
    .modal .btnRow2{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top: 12px; }
    .btnNext{ background: linear-gradient(135deg, #22c55e, #a3e635); }

    .tiny{
      font-size: 12px;
      opacity:.9;
      margin-top: 10px;
      text-align:center;
      user-select:none;
      color:#ffffffdd;
      text-shadow: 0 2px 10px rgba(0,0,0,.25);
      font-weight: 800;
    }

    /* RTL tweaks */
    [dir="rtl"] .title { flex-direction: row-reverse; }
    [dir="rtl"] .topbar { direction: rtl; }
    [dir="rtl"] .globalCard { direction: rtl; }
    [dir="rtl"] .playerHeader { direction: rtl; }
    [dir="rtl"] .statsRow { direction: rtl; }
    [dir="rtl"] .questionBox { direction: rtl; }
    [dir="rtl"] .progressTop { direction: rtl; }
    [dir="rtl"] .trackMarks { direction: rtl; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <div class="logo">ğŸ§ </div>
        <div>
          <h1 id="ui_title">Math Quest ğŸª™</h1>
          <div class="subtitle" id="ui_subtitle">Only + and âˆ’ â€¢ no negative answers â€¢ Hint â€¢ Pop stays 4 seconds</div>
        </div>
      </div>

      <div class="langWrap">
        <label id="ui_langLabel" for="lang">Language:</label>
        <select id="lang">
          <option value="en">English</option>
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="es">EspaÃ±ol</option>
        </select>
      </div>
    </div>

    <div class="globalCard">
      <div class="pill" id="ui_tip">âœ¨ Each player plays independently. Right âœ… / Wrong âŒ</div>
      <div class="actions">
        <button class="btnReset" id="resetAll">ğŸ”„ Reset Game</button>
      </div>
    </div>

    <div class="grid">
      <!-- Player 1 -->
      <div class="playerCard">
        <div class="playerHeader">
          <div class="tag">
            <div class="badge b1">1</div>
            <div id="ui_p1">Player 1</div>
          </div>
          <div class="nameRow">
            <label id="ui_nameLabel1" for="name1">Name:</label>
            <input id="name1" type="text" placeholder="e.g., Fahad" maxlength="14" />
          </div>
        </div>

        <!-- Progress Car -->
        <div class="progressWrap">
          <div class="progressTop">
            <div id="ui_progress1">ğŸš— Progress</div>
            <div><span id="ui_step1">Step</span> <b id="stepNow1">1</b>/<b id="stepMax1">6</b></div>
          </div>
          <div class="track" id="track1" style="--pos:0;">
            <div class="fill" id="fill1" style="--pos:0;"></div>
            <div class="car" id="car1">ğŸš—</div>
          </div>
          <div class="trackMarks">
            <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span>
          </div>
        </div>

        <div class="statsRow">
          <div class="pill"><span id="ui_level">ğŸŒŸ Level:</span> <b id="level1">1</b></div>
          <div class="pill"><span id="ui_coins">ğŸª™ Coins:</span> <b id="coins1">0</b></div>
          <div class="pill"><span id="ui_q">ğŸ“Œ Q:</span> <b id="qnum1">1</b>/<span id="qmax1">6</span></div>
          <div class="pill"><span id="ui_hint">ğŸ’¡ Hint:</span> <b id="hintcost1">3</b> <span id="ui_coinWord">coins</span></div>
        </div>

        <div class="questionBox">
          <div class="question" id="question1">Startingâ€¦</div>
          <div class="mascot" id="mascot1">ğŸµ</div>
        </div>

        <div style="margin-top:10px; font-weight: 900; font-size: 13px;" id="ui_answer">Your Answer</div>
        <input id="ans1" type="number" inputmode="numeric" placeholder="Type your answerâ€¦" />

        <div class="btnRow">
          <button class="btnSubmit" id="submit1">âœ… Submit</button>
          <button class="btnHint" id="hint1">ğŸ’¡ Hint</button>
        </div>
      </div>

      <!-- Player 2 -->
      <div class="playerCard">
        <div class="playerHeader">
          <div class="tag">
            <div class="badge b2">2</div>
            <div id="ui_p2">Player 2</div>
          </div>
          <div class="nameRow">
            <label id="ui_nameLabel2" for="name2">Name:</label>
            <input id="name2" type="text" placeholder="e.g., Sara" maxlength="14" />
          </div>
        </div>

        <!-- Progress Car -->
        <div class="progressWrap">
          <div class="progressTop">
            <div id="ui_progress2">ğŸš™ Progress</div>
            <div><span id="ui_step2">Step</span> <b id="stepNow2">1</b>/<b id="stepMax2">6</b></div>
          </div>
          <div class="track" id="track2" style="--pos:0;">
            <div class="fill" id="fill2" style="--pos:0;"></div>
            <div class="car" id="car2">ğŸš™</div>
          </div>
          <div class="trackMarks">
            <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span>
          </div>
        </div>

        <div class="statsRow">
          <div class="pill"><span id="ui_level2">ğŸŒŸ Level:</span> <b id="level2">1</b></div>
          <div class="pill"><span id="ui_coins2">ğŸª™ Coins:</span> <b id="coins2">0</b></div>
          <div class="pill"><span id="ui_q2">ğŸ“Œ Q:</span> <b id="qnum2">1</b>/<span id="qmax2">6</span></div>
          <div class="pill"><span id="ui_hint2">ğŸ’¡ Hint:</span> <b id="hintcost2">3</b> <span id="ui_coinWord2">coins</span></div>
        </div>

        <div class="questionBox">
          <div class="question" id="question2">Startingâ€¦</div>
          <div class="mascot" id="mascot2">ğŸ¦Š</div>
        </div>

        <div style="margin-top:10px; font-weight: 900; font-size: 13px;" id="ui_answer2">Your Answer</div>
        <input id="ans2" type="number" inputmode="numeric" placeholder="Type your answerâ€¦" />

        <div class="btnRow">
          <button class="btnSubmit" id="submit2">âœ… Submit</button>
          <button class="btnHint" id="hint2">ğŸ’¡ Hint</button>
        </div>
      </div>
    </div>

    <div class="tiny">
Ù„Ø¹Ø¨Ø© ÙÙ‡Ø¯ Ø¨Ù† Ø«Ø§Ù…Ø± Ø§Ù„Ø­Ø±Ø¨ÙŠ     </div>
  </div>

  <!-- Pop Badge -->
  <div class="popBadge" id="popBadge">âœ… Right!</div>

  <!-- Level Result Overlay -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div style="font-size:42px" id="modalEmoji">ğŸ‰</div>
      <h2 id="modalTitle">Level Complete!</h2>
      <div class="big" id="modalBig">Total: 0 coins</div>
      <p id="modalSmall">Press Next Level to continue!</p>
      <div class="btnRow2">
        <button class="btnNext" id="modalNext">â¡ï¸ Next Level</button>
        <button class="btnReset" id="modalReset">ğŸ”„ Reset</button>
      </div>
    </div>
  </div>

  <script type="py">
import random
from pyscript import document
from pyodide.ffi import create_proxy

# ---------- i18n ----------
I18N = {
  "en": {
    "dir":"ltr",
    "title":"Math Quest ğŸª™",
    "subtitle":"Only + and âˆ’ â€¢ no negative answers â€¢ Hint â€¢ Pop stays 4 seconds",
    "langLabel":"Language:",
    "tip":"âœ¨ Each player plays independently. Right âœ… / Wrong âŒ",
    "reset":"ğŸ”„ Reset Game",
    "p1":"Player 1",
    "p2":"Player 2",
    "name":"Name:",
    "name_ph_1":"e.g., Fahad",
    "name_ph_2":"e.g., Sara",
    "level":"ğŸŒŸ Level:",
    "coins":"ğŸª™ Coins:",
    "q":"ğŸ“Œ Q:",
    "hint":"ğŸ’¡ Hint:",
    "coinWord":"coins",
    "answer":"Your Answer",
    "ans_ph":"Type your answerâ€¦",
    "submit":"âœ… Submit",
    "hint_btn":"ğŸ’¡ Hint",
    "type_num":"âœï¸ Type a number!",
    "right":"âœ… RIGHT! +10 ğŸª™",
    "wrong":"âŒ WRONG!",
    "not_enough":"ğŸª™ Not enough coins for hint!",
    "hint_used":"ğŸ’¡ Hint already used!",
    "hint_used_pop":"ğŸ’¡ Hint used",
    "modal_level_done":"ğŸ {name} finished Level {level}!",
    "modal_total":"Total: {coins} coins ğŸª™",
    "modal_next_text":"Press Next Level to continue!",
    "next":"â¡ï¸ Next Level",
    "progress":"ğŸš— Progress",
    "step":"Step",
  },
  "ar": {
    "dir":"rtl",
    "title":"Ù…ØºØ§Ù…Ø±Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ğŸª™",
    "subtitle":"ÙÙ‚Ø· + Ùˆ âˆ’ â€¢ Ø¨Ø¯ÙˆÙ† Ù†ØªØ§Ø¦Ø¬ Ø³Ù„Ø¨ÙŠØ© â€¢ ØªÙ„Ù…ÙŠØ­ â€¢ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙŠØ¸Ù‡Ø± Ù¤ Ø«ÙˆØ§Ù†Ù",
    "langLabel":"Ø§Ù„Ù„ØºØ©:",
    "tip":"âœ¨ ÙƒÙ„ Ù„Ø§Ø¹Ø¨ ÙŠÙ„Ø¹Ø¨ Ù„ÙˆØ­Ø¯Ù‡. ØµØ­ÙŠØ­ âœ… / Ø®Ø·Ø£ âŒ",
    "reset":"ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨",
    "p1":"Ø§Ù„Ù„Ø§Ø¹Ø¨ 1",
    "p2":"Ø§Ù„Ù„Ø§Ø¹Ø¨ 2",
    "name":"Ø§Ù„Ø§Ø³Ù…:",
    "name_ph_1":"Ù…Ø«Ø§Ù„: ÙÙ‡Ø¯",
    "name_ph_2":"Ù…Ø«Ø§Ù„: Ø³Ø§Ø±Ø©",
    "level":"ğŸŒŸ Ø§Ù„Ù…Ø³ØªÙˆÙ‰:",
    "coins":"ğŸª™ Ø§Ù„Ø¹Ù…Ù„Ø§Øª:",
    "q":"ğŸ“Œ Ø§Ù„Ø³Ø¤Ø§Ù„:",
    "hint":"ğŸ’¡ ØªÙ„Ù…ÙŠØ­:",
    "coinWord":"Ø¹Ù…Ù„Ø§Øª",
    "answer":"Ø¥Ø¬Ø§Ø¨ØªÙƒ",
    "ans_ph":"Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©â€¦",
    "submit":"âœ… Ø¥Ø±Ø³Ø§Ù„",
    "hint_btn":"ğŸ’¡ ØªÙ„Ù…ÙŠØ­",
    "type_num":"âœï¸ Ø§ÙƒØªØ¨ Ø±Ù‚Ù…Ù‹Ø§!",
    "right":"âœ… ØµØ­ÙŠØ­! +10 ğŸª™",
    "wrong":"âŒ Ø®Ø·Ø£!",
    "not_enough":"ğŸª™ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„ØªÙ„Ù…ÙŠØ­!",
    "hint_used":"ğŸ’¡ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙ„Ù…ÙŠØ­!",
    "hint_used_pop":"ğŸ’¡ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙ„Ù…ÙŠØ­",
    "modal_level_done":"ğŸ {name} Ø£Ù†Ù‡Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ {level}!",
    "modal_total":"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: {coins} Ø¹Ù…Ù„Ø© ğŸª™",
    "modal_next_text":"Ø§Ø¶ØºØ· Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©!",
    "next":"â¡ï¸ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ",
    "progress":"ğŸš— Ø§Ù„ØªÙ‚Ø¯Ù…",
    "step":"Ø§Ù„Ø®Ø·ÙˆØ©",
  },
  "es": {
    "dir":"ltr",
    "title":"Aventura MatemÃ¡tica ğŸª™",
    "subtitle":"Solo + y âˆ’ â€¢ sin respuestas negativas â€¢ Pista â€¢ Aviso 4 segundos",
    "langLabel":"Idioma:",
    "tip":"âœ¨ Cada jugador juega solo. Correcto âœ… / Incorrecto âŒ",
    "reset":"ğŸ”„ Reiniciar",
    "p1":"Jugador 1",
    "p2":"Jugador 2",
    "name":"Nombre:",
    "name_ph_1":"Ej.: Fahad",
    "name_ph_2":"Ej.: Sara",
    "level":"ğŸŒŸ Nivel:",
    "coins":"ğŸª™ Monedas:",
    "q":"ğŸ“Œ P:",
    "hint":"ğŸ’¡ Pista:",
    "coinWord":"monedas",
    "answer":"Tu respuesta",
    "ans_ph":"Escribe la respuestaâ€¦",
    "submit":"âœ… Enviar",
    "hint_btn":"ğŸ’¡ Pista",
    "type_num":"âœï¸ Escribe un nÃºmero!",
    "right":"âœ… Â¡CORRECTO! +10 ğŸª™",
    "wrong":"âŒ Â¡INCORRECTO!",
    "not_enough":"ğŸª™ No hay monedas para la pista!",
    "hint_used":"ğŸ’¡ Â¡Pista ya usada!",
    "hint_used_pop":"ğŸ’¡ Pista usada",
    "modal_level_done":"ğŸ Â¡{name} terminÃ³ el Nivel {level}!",
    "modal_total":"Total: {coins} monedas ğŸª™",
    "modal_next_text":"Pulsa Siguiente Nivel para continuar!",
    "next":"â¡ï¸ Siguiente Nivel",
    "progress":"ğŸš— Progreso",
    "step":"Paso",
  }
}

lang = "en"

def el(id_): return document.getElementById(id_)
def t(key): return I18N[lang][key]

def set_dir_and_lang():
    root = document.getElementById("htmlRoot")
    root.lang = lang
    root.dir = I18N[lang]["dir"]

def set_text(id_, txt):
    el(id_).textContent = str(txt)

def set_ui_strings():
    set_dir_and_lang()

    set_text("ui_title", t("title"))
    set_text("ui_subtitle", t("subtitle"))
    set_text("ui_langLabel", t("langLabel"))
    set_text("ui_tip", t("tip"))
    el("resetAll").textContent = t("reset")

    set_text("ui_p1", t("p1"))
    set_text("ui_p2", t("p2"))

    set_text("ui_nameLabel1", t("name"))
    set_text("ui_nameLabel2", t("name"))
    el("name1").placeholder = t("name_ph_1")
    el("name2").placeholder = t("name_ph_2")

    set_text("ui_level", t("level"))
    set_text("ui_level2", t("level"))
    set_text("ui_coins", t("coins"))
    set_text("ui_coins2", t("coins"))
    set_text("ui_q", t("q"))
    set_text("ui_q2", t("q"))
    set_text("ui_hint", t("hint"))
    set_text("ui_hint2", t("hint"))

    set_text("ui_coinWord", t("coinWord"))
    set_text("ui_coinWord2", t("coinWord"))

    set_text("ui_answer", t("answer"))
    set_text("ui_answer2", t("answer"))
    el("ans1").placeholder = t("ans_ph")
    el("ans2").placeholder = t("ans_ph")

    el("submit1").textContent = t("submit")
    el("submit2").textContent = t("submit")
    el("hint1").textContent = t("hint_btn")
    el("hint2").textContent = t("hint_btn")

    el("modalNext").textContent = t("next")
    el("modalReset").textContent = t("reset")

    # progress labels
    set_text("ui_progress1", t("progress"))
    set_text("ui_progress2", t("progress"))
    set_text("ui_step1", t("step"))
    set_text("ui_step2", t("step"))

# ---------- iPad scroll lock while typing ----------
_saved_scroll_y = 0

def lock_scroll(*_):
    # prevents page jumping when iOS keyboard opens
    global _saved_scroll_y
    _saved_scroll_y = int(document.defaultView.scrollY)
    body = document.body
    body.style.position = "fixed"
    body.style.top = f"-{_saved_scroll_y}px"
    body.style.left = "0"
    body.style.right = "0"
    body.style.width = "100%"

def unlock_scroll(*_):
    body = document.body
    top = body.style.top
    body.style.position = ""
    body.style.top = ""
    body.style.left = ""
    body.style.right = ""
    body.style.width = ""
    try:
        y = int(top.replace("px","").replace("-","")) if top else 0
    except:
        y = 0
    document.defaultView.scrollTo(0, y)

# ---------- UI helpers ----------
def coins_pop(pid: int, value: int):
    el(f"coins{pid}").innerHTML = f'<span class="coinsPop">{value}</span>'

def show_pop(text: str, kind: str):
    badge = el("popBadge")
    badge.textContent = text
    badge.className = "popBadge"
    if kind == "good":
        badge.classList.add("popGood")
    elif kind == "bad":
        badge.classList.add("popBad")
    else:
        badge.classList.add("popInfo")
    badge.classList.add("popShow")

    def hide_later(*_):
        badge.classList.remove("popShow")

    document.defaultView.setTimeout(create_proxy(hide_later), 4000)

def open_modal(pid: int, title: str, big: str, small: str, emoji="ğŸ‰"):
    overlay = el("overlay")
    overlay.dataset.pid = str(pid)
    el("modalEmoji").textContent = emoji
    el("modalTitle").textContent = title
    el("modalBig").textContent = big
    el("modalSmall").textContent = small
    overlay.classList.add("show")

def close_modal():
    el("overlay").classList.remove("show")

# ---------- game settings ----------
QUESTIONS_PER_LEVEL = 6
MASCOTS = ["ğŸµ","ğŸ¦Š","ğŸ¸","ğŸ¯","ğŸ¼","ğŸ¦","ğŸ¶","ğŸ±","ğŸ¦„","ğŸ™","ğŸ§","ğŸ°","ğŸ¨","ğŸ¦‹","ğŸ"]

def hint_cost(lv: int) -> int:
    return 3 + (lv - 1) * 1

def make_question(lv: int):
    # Only + and -, no negative result
    max_n = 20 + (lv - 1) * 10
    op = random.choice(["+","-"])
    a = random.randint(1, max_n)
    b = random.randint(1, max_n)

    if op == "-":
        if b > a:
            a, b = b, a
        ans = a - b
        hint_txt = f"{a} âˆ’ {b}"
    else:
        ans = a + b
        hint_txt = f"{a} + {b}"

    return {"text": f"{a} {op} {b} = ?", "answer": ans, "hint": hint_txt}

def read_int(value):
    try: return int(value)
    except: return None

def safe_name(pid: int) -> str:
    name = el(f"name{pid}").value.strip()
    if name:
        return name
    return t("p1") if pid == 1 else t("p2")

# ---------- per-player state ----------
players = {
    1: {"level": 1, "coins": 0, "q_index": 1, "current": None, "hint_used": False},
    2: {"level": 1, "coins": 0, "q_index": 1, "current": None, "hint_used": False},
}

def set_progress(pid: int):
    st = players[pid]
    # progress position (0.0 .. 1.0)
    # q_index = 1 means start (0 progress)
    pos = (st["q_index"] - 1) / QUESTIONS_PER_LEVEL
    if pos < 0: pos = 0
    if pos > 1: pos = 1

    track = el(f"track{pid}")
    fill = el(f"fill{pid}")
    track.style.setProperty("--pos", str(pos))
    fill.style.setProperty("--pos", str(pos))

    set_text(f"stepNow{pid}", st["q_index"])
    set_text(f"stepMax{pid}", QUESTIONS_PER_LEVEL)

def render(pid: int):
    st = players[pid]
    set_text(f"level{pid}", st["level"])
    coins_pop(pid, st["coins"])
    set_text(f"qnum{pid}", st["q_index"])
    set_text(f"qmax{pid}", QUESTIONS_PER_LEVEL)
    set_text(f"question{pid}", st["current"]["text"])
    set_text(f"mascot{pid}", random.choice(MASCOTS))
    set_text(f"hintcost{pid}", hint_cost(st["level"]))
    set_progress(pid)

def new_round(pid: int):
    st = players[pid]
    st["hint_used"] = False
    st["current"] = make_question(st["level"])
    el(f"ans{pid}").value = ""
    render(pid)

def finish_level(pid: int):
    st = players[pid]
    nm = safe_name(pid)
    title = t("modal_level_done").format(name=nm, level=st["level"])
    big = t("modal_total").format(coins=st["coins"])
    small = t("modal_next_text")
    open_modal(pid, title, big, small, emoji="ğŸ")

def go_next_level(pid: int):
    st = players[pid]
    st["level"] += 1
    st["q_index"] = 1
    new_round(pid)

def submit_for(pid: int, evt=None):
    st = players[pid]
    nm = safe_name(pid)
    user_ans = read_int(el(f"ans{pid}").value)
    ans = st["current"]["answer"]

    if user_ans is None:
        show_pop(t("type_num"), "info")
        return

    if user_ans == ans:
        st["coins"] += 10
        show_pop(f"{t('right')} ({nm})", "good")
    else:
        show_pop(f"{t('wrong')} ({nm})", "bad")

    st["q_index"] += 1
    if st["q_index"] > QUESTIONS_PER_LEVEL:
        render(pid)
        finish_level(pid)
    else:
        new_round(pid)

def hint_for(pid: int, evt=None):
    st = players[pid]
    nm = safe_name(pid)

    if st["hint_used"]:
        show_pop(t("hint_used"), "info")
        return

    cost = hint_cost(st["level"])
    if st["coins"] < cost:
        show_pop(t("not_enough"), "bad")
        return

    st["coins"] -= cost
    st["hint_used"] = True

    # Hint shown in pop only (no history)
    show_pop(f"{t('hint_used_pop')} (-{cost}) â€¢ {st['current']['hint']} ({nm})", "info")
    render(pid)

def reset_all(evt=None):
    close_modal()
    for pid in (1, 2):
        players[pid]["level"] = 1
        players[pid]["coins"] = 0
        players[pid]["q_index"] = 1
        players[pid]["hint_used"] = False
        new_round(pid)

def on_lang_change(evt=None):
    global lang
    lang = el("lang").value
    set_ui_strings()
    render(1)
    render(2)

def modal_next(evt=None):
    overlay = el("overlay")
    pid = int(overlay.dataset.pid or "1")
    close_modal()
    go_next_level(pid)

def modal_reset(evt=None):
    reset_all()

# ---------- wire events (create_proxy) ----------
submit1_proxy = create_proxy(lambda e: submit_for(1, e))
hint1_proxy   = create_proxy(lambda e: hint_for(1, e))
submit2_proxy = create_proxy(lambda e: submit_for(2, e))
hint2_proxy   = create_proxy(lambda e: hint_for(2, e))

reset_proxy   = create_proxy(reset_all)
next_proxy    = create_proxy(modal_next)
mreset_proxy  = create_proxy(modal_reset)
lang_proxy    = create_proxy(on_lang_change)

# iPad scroll lock for answer inputs
lock_proxy = create_proxy(lock_scroll)
unlock_proxy = create_proxy(unlock_scroll)

el("submit1").addEventListener("click", submit1_proxy)
el("hint1").addEventListener("click", hint1_proxy)
el("submit2").addEventListener("click", submit2_proxy)
el("hint2").addEventListener("click", hint2_proxy)

el("resetAll").addEventListener("click", reset_proxy)
el("modalNext").addEventListener("click", next_proxy)
el("modalReset").addEventListener("click", mreset_proxy)
el("lang").addEventListener("change", lang_proxy)

# lock/unlock scroll on focus/blur (prevents page dropping on iPad)
el("ans1").addEventListener("focus", lock_proxy)
el("ans1").addEventListener("blur", unlock_proxy)
el("ans2").addEventListener("focus", lock_proxy)
el("ans2").addEventListener("blur", unlock_proxy)

# init
set_ui_strings()
reset_all()
  </script>
</body>
</html>
